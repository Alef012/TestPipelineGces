name: Ruby App CI

on: [push, pull_request]

jobs:
  build_and_test:
    runs-on: ubuntu-22.04

    services:
      postgres:
        image: postgres:13.2-alpine
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        env: 
          POSTGRES_PASSWORD: postgres

      redis-queue:
        image: redis:6.0.12-alpine

      redis-cache:
        image: redis:6.0.12-alpine

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build Docker image
        run: docker-compose -f docker-compose.yml build

      - name: Run Tests
        run: docker-compose run --rm app bundle exec rspec

      - name: Run Lint
        run: docker-compose run --rm app bundle exec rubocop
        continue-on-error: true
